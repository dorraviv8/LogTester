<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogTester</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --card2:#0e1525;
      --border:#202a40; --border2:#2a3550;
      --text:#e7eaf3; --muted:#aab1c5;
      --blue:#2d6cff; --green:#7ee787; --red:#ff7b72; --yellow:#f2cc60;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 18px 60px; }
    .title { font-size: 28px; font-weight: 700; letter-spacing: 0.2px; }
    .sub { margin-top: 6px; color: var(--muted); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 18px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.2fr 0.8fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }

    textarea { width: 100%; min-height: 260px; resize: vertical; border-radius: 12px; border: 1px solid var(--border2); background: var(--card2); color: var(--text); padding: 12px; line-height: 1.35; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size: 13px; }
    label { display: block; margin: 0 0 8px; color: #c9cfe3; font-weight: 600; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    select, button, input { border-radius: 12px; border: 1px solid var(--border2); background: var(--card2); color: var(--text); padding: 10px 12px; }
    button { cursor: pointer; font-weight: 700; }
    button.primary { background: var(--blue); border-color: var(--blue); }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: 13px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }

    .pill { display:inline-flex; gap:6px; align-items:center; padding: 6px 10px; border-radius: 999px; background: var(--card2); border:1px solid var(--border2); color:#c9cfe3; font-size:12px; }
    .ok { color: var(--green); }
    .bad { color: var(--red); }

    /* Result UI */
    .resultWrap { display: grid; gap: 10px; }
    .resultEmpty { color: var(--muted); font-size: 13px; }
    .section { background: var(--card2); border: 1px solid var(--border2); border-radius: 12px; padding: 12px; }
    .sectionTitle { display:flex; align-items:center; justify-content:space-between; gap: 10px; font-weight: 800; margin-bottom: 8px; }
    .sectionBody { color: #d6daf0; font-size: 13.5px; line-height: 1.45; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border:1px solid var(--border2); background: rgba(255,255,255,0.02); font-size: 12px; }
    .badge.good { border-color: rgba(126,231,135,.35); color: var(--green); }
    .badge.warn { border-color: rgba(242,204,96,.35); color: var(--yellow); }
    .badge.bad  { border-color: rgba(255,123,114,.35); color: var(--red); }

    .kv { display:grid; gap: 6px; }
    .kvRow { display:grid; grid-template-columns: 1fr; gap: 6px; }
    .kvLabel { color: var(--muted); font-size: 12px; font-weight: 700; letter-spacing: .2px; text-transform: uppercase; }
    .monoBox { margin:0; white-space: pre-wrap; word-break: break-word; background: #0b1120; border: 1px solid var(--border2); border-radius: 12px; padding: 12px; font-size: 12.5px; line-height: 1.35; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }

    .fixList { margin: 0; padding-left: 18px; }
    .fixList li { margin: 6px 0; }

    .bar { height: 10px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border2); overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: var(--blue); }
    .barMeta { display:flex; justify-content:space-between; color: var(--muted); font-size: 12px; margin-top: 6px; }

    details { border-radius: 12px; }
    summary { cursor: pointer; color: #c9cfe3; font-weight: 800; }
    .small { font-size: 12px; color: var(--muted); }

    .right { text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">LogTester</div>
    <div class="sub">Paste a log, detect the error, and get a clear explanation + suggested fixes.</div>

    <div class="grid">
      <div class="card">
        <label for="log">Log / Error text</label>
        <textarea id="log" placeholder="Paste your logs here...&#10;&#10;Example:&#10;ERROR: connection refused..."></textarea>

        <div class="row">
          <label class="hint" style="margin:0;">Source:</label>
          <select id="source">
            <option value="generic">generic</option>
            <option value="jenkins">jenkins</option>
            <option value="kubernetes">kubernetes</option>
            <option value="docker">docker</option>
            <option value="python">python</option>
          </select>

          <button class="primary" id="analyzeBtn">Analyze</button>
          <button id="clearBtn">Clear</button>

          <span class="hint" id="status"></span>
        </div>

        <div class="row" style="margin-top:10px;">
          <span class="pill">API: <span id="apiHealth">unknown</span></span>
          <span class="pill">Endpoint: <code>/analyze</code></span>
          <span class="pill">Docs: <a href="/docs" style="color:#9db7ff;">/docs</a></span>
        </div>

        <div class="row" style="margin-top:10px;">
          <span class="hint small">Tip: Use <b>jenkins</b> source for pipeline logs.</span>
        </div>
      </div>

      <div class="card">
        <label>Result</label>
        <div id="result" class="resultWrap">
          <div class="resultEmpty">Waiting for input...</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const logEl = document.getElementById("log");
  const sourceEl = document.getElementById("source");
  const btn = document.getElementById("analyzeBtn");
  const clearBtn = document.getElementById("clearBtn");
  const resultEl = document.getElementById("result");
  const statusEl = document.getElementById("status");
  const apiHealthEl = document.getElementById("apiHealth");

  async function checkHealth(){
    try {
      const r = await fetch("/health");
      if(!r.ok) throw new Error("bad status");
      const j = await r.json();
      apiHealthEl.textContent = j.status || "ok";
      apiHealthEl.className = "ok";
    } catch(e){
      apiHealthEl.textContent = "down";
      apiHealthEl.className = "bad";
    }
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function asArray(val){
    if(Array.isArray(val)) return val;
    if(val == null) return [];
    return [val];
  }

  function normalizeConfidence(conf){
    // supports: 0-1, 0-100, or string
    if(conf == null) return null;
    if(typeof conf === "string"){
      const n = Number(conf);
      if(Number.isFinite(n)) conf = n;
      else return null;
    }
    if(typeof conf === "number"){
      if(conf <= 1) return Math.round(conf * 100);
      if(conf <= 100) return Math.round(conf);
      return 100;
    }
    return null;
  }

  function confidenceBadgeClass(pct){
    if(pct == null) return "warn";
    if(pct >= 80) return "good";
    if(pct >= 50) return "warn";
    return "bad";
  }

  function createSection(title, innerHtml, rightMetaHtml=""){
    const el = document.createElement("div");
    el.className = "section";
    el.innerHTML = `
      <div class="sectionTitle">
        <span>${escapeHtml(title)}</span>
        ${rightMetaHtml ? `<span class="small right">${rightMetaHtml}</span>` : ""}
      </div>
      <div class="sectionBody">${innerHtml}</div>
    `;
    return el;
  }

  function renderResult(data){
    resultEl.innerHTML = "";

    // Defensive: if API returned something unexpected
    if(!data || typeof data !== "object"){
      resultEl.innerHTML = `<div class="resultEmpty">Unexpected response. Try again.</div>`;
      return;
    }

    const errorType = data.error_type ?? "unknown";
    const summary = data.root_cause_summary ?? "";
    const cause = data.most_likely_cause ?? "";
    const fixes = asArray(data.suggested_fixes);
    const extracted = asArray(data.extracted_error_lines);
    const confPct = normalizeConfidence(data.confidence);

    const badgeCls = confidenceBadgeClass(confPct);

    // Header section (type + confidence)
    const header = document.createElement("div");
    header.className = "section";
    header.innerHTML = `
      <div class="sectionTitle">
        <span>Overview</span>
        <span class="badge ${badgeCls}">
          ${confPct == null ? "Confidence: n/a" : `Confidence: ${confPct}%`}
        </span>
      </div>
      <div class="sectionBody">
        <div class="kv">
          <div class="kvRow">
            <div class="kvLabel">Error Type</div>
            <div><span class="badge ${badgeCls}">${escapeHtml(errorType)}</span></div>
          </div>

          <div class="kvRow" style="margin-top:10px;">
            <div class="kvLabel">Confidence</div>
            <div class="bar"><div id="confBar"></div></div>
            <div class="barMeta">
              <span>${confPct == null ? "unknown" : "low"}</span>
              <span>${confPct == null ? "" : confPct + "%"}</span>
              <span>${confPct == null ? "" : "high"}</span>
            </div>
          </div>
        </div>
      </div>
    `;
    resultEl.appendChild(header);

    const confBar = header.querySelector("#confBar");
    if(confBar){
      confBar.style.width = (confPct == null ? 35 : confPct) + "%";
      // change bar color slightly by confidence
      confBar.style.background = (confPct == null ? "var(--yellow)" : (confPct >= 80 ? "var(--green)" : confPct >= 50 ? "var(--yellow)" : "var(--red)"));
    }

    // Explanation section
    const summaryHtml = summary
      ? `<div>${escapeHtml(summary)}</div>`
      : `<div class="resultEmpty">No summary provided.</div>`;

    resultEl.appendChild(createSection("Explanation (Root cause summary)", summaryHtml));

    // Likely cause section
    const causeHtml = cause
      ? `<div>${escapeHtml(cause)}</div>`
      : `<div class="resultEmpty">No likely cause provided.</div>`;

    resultEl.appendChild(createSection("Most likely cause", causeHtml));

    // Fixes section
    let fixesHtml = "";
    if(fixes.length){
      fixesHtml = `<ol class="fixList">` + fixes.map(f => `<li>${escapeHtml(f)}</li>`).join("") + `</ol>`;
    } else {
      fixesHtml = `<div class="resultEmpty">No suggested fixes returned.</div>`;
    }
    resultEl.appendChild(createSection("Suggested fixes (what to do next)", fixesHtml));

    // Extracted lines section (collapsible if big)
    let extractedText = extracted.filter(Boolean).join("\n");
    if(!extractedText){
      extractedText = "";
    }
    const linesCount = extractedText ? extractedText.split("\n").length : 0;

    const extractedHtml = extractedText
      ? `
        <details open>
          <summary>Relevant log lines (${linesCount})</summary>
          <div style="margin-top:10px;">
            <div class="monoBox">${escapeHtml(extractedText)}</div>
          </div>
        </details>
      `
      : `<div class="resultEmpty">No extracted error lines found.</div>`;

    resultEl.appendChild(createSection("Evidence", extractedHtml));

    // Raw JSON (debug, collapsed)
    const rawHtml = `
      <details>
        <summary>Raw response (debug)</summary>
        <div style="margin-top:10px;">
          <div class="monoBox">${escapeHtml(JSON.stringify(data, null, 2))}</div>
        </div>
      </details>
    `;
    resultEl.appendChild(createSection("Advanced", rawHtml));
  }

  btn.addEventListener("click", async () => {
    const text = (logEl.value || "").trim();
    if(!text){
      resultEl.innerHTML = `<div class="resultEmpty">Paste a log first.</div>`;
      return;
    }

    btn.disabled = true;
    statusEl.textContent = "Analyzing...";
    resultEl.innerHTML = `<div class="resultEmpty">Working...</div>`;

    try {
      const r = await fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ log_text: text, source: sourceEl.value })
      });

      const data = await r.json().catch(() => null);

      if(!r.ok){
        resultEl.innerHTML = `
          <div class="section">
            <div class="sectionTitle"><span>Request failed</span><span class="badge bad">${r.status}</span></div>
            <div class="sectionBody">
              <div class="monoBox">${escapeHtml(JSON.stringify(data, null, 2) || "No body")}</div>
            </div>
          </div>
        `;
        statusEl.textContent = "Request failed.";
        return;
      }

      renderResult(data);
      statusEl.textContent = "Done.";
    } catch (e){
      resultEl.innerHTML = `
        <div class="section">
          <div class="sectionTitle"><span>Network error</span><span class="badge bad">failed</span></div>
          <div class="sectionBody">${escapeHtml(String(e))}</div>
        </div>
      `;
      statusEl.textContent = "Failed.";
    } finally {
      btn.disabled = false;
      setTimeout(() => statusEl.textContent = "", 2500);
    }
  });

  clearBtn.addEventListener("click", () => {
    logEl.value = "";
    resultEl.innerHTML = `<div class="resultEmpty">Waiting for input...</div>`;
    statusEl.textContent = "";
  });

  checkHealth();
</script>
</body>
</html>

